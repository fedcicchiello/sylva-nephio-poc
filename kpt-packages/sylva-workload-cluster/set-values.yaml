apiVersion: fn.kpt.dev/v1alpha1
kind: StarlarkRun
metadata: # kpt-merge: /generate-values
  name: generate-values
  annotations:
    config.kubernetes.io/local-config: "true"
    internal.kpt.dev/upstream-identifier: fn.kpt.dev|StarlarkRun|default|generate-values
source: |-
  load("krmfn.star", "krmfn")
  def set_values(resources):
    for r in resources:
      if krmfn.match_gvk(r, "v1", "ConfigMap") and krmfn.match_name(r, "layers"):
        layers = r["data"]["layers"]
    for r in resources:
      if krmfn.match_gvk(r, "unitsoperator.sylva/v1alpha1", "SylvaUnitsRelease"):
        for l in layers:
          r["spec"]["valuesFrom"].append(l)
  set_values(ctx.resource_list["items"])
